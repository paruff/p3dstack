name: Configuration and Documentation Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  yaml-validation:
    name: Validate YAML Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate YAML syntax
        run: |
          echo "Validating YAML files..."
          find . -name "*.yml" -o -name "*.yaml" | while read file; do
            echo "Checking $file"
            yamllint -d "{extends: default, rules: {line-length: {max: 120}, comments: {min-spaces-from-content: 1}}}" "$file" || exit 1
          done

      - name: Validate docker-compose syntax
        run: |
          echo "Validating docker-compose.yml..."
          docker-compose config > /dev/null || exit 1

  production-config-check:
    name: Verify Production-Ready Configurations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make verification script executable
        run: chmod +x verify-production.sh

      - name: Run production configuration verification
        run: ./verify-production.sh

      - name: Check health check configurations
        run: |
          echo "Verifying all services have health checks..."
          missing_healthcheck=()
          for file in services/*.yml; do
            if ! grep -q "healthcheck:" "$file"; then
              missing_healthcheck+=("$file")
            fi
          done
          
          if [ ${#missing_healthcheck[@]} -gt 0 ]; then
            echo "❌ The following services are missing health checks:"
            printf '%s\n' "${missing_healthcheck[@]}"
            exit 1
          fi
          echo "✓ All services have health checks"

      - name: Check restart policies
        run: |
          echo "Verifying all services have restart policies..."
          missing_restart=()
          for file in services/*.yml; do
            if ! grep -q "restart:" "$file"; then
              missing_restart+=("$file")
            fi
          done
          
          if [ ${#missing_restart[@]} -gt 0 ]; then
            echo "❌ The following services are missing restart policies:"
            printf '%s\n' "${missing_restart[@]}"
            exit 1
          fi
          echo "✓ All services have restart policies"

      - name: Check resource limits
        run: |
          echo "Verifying all services have resource limits..."
          missing_resources=()
          for file in services/*.yml; do
            if ! grep -q "resources:" "$file"; then
              missing_resources+=("$file")
            fi
          done
          
          if [ ${#missing_resources[@]} -gt 0 ]; then
            echo "⚠️  The following services are missing resource limits:"
            printf '%s\n' "${missing_resources[@]}"
            echo "Note: This is a warning, not a failure"
          else
            echo "✓ All services have resource limits"
          fi

      - name: Check OTEL configuration
        run: |
          echo "Verifying services have OTEL configuration..."
          missing_otel=()
          for file in services/*.yml; do
            # Skip telemetry.yml as it's the OTEL collector itself
            if [[ "$file" == "services/telemetry.yml" ]]; then
              continue
            fi
            if ! grep -q "OTEL_EXPORTER_OTLP_ENDPOINT" "$file"; then
              missing_otel+=("$file")
            fi
          done
          
          if [ ${#missing_otel[@]} -gt 0 ]; then
            echo "⚠️  The following services are missing OTEL configuration:"
            printf '%s\n' "${missing_otel[@]}"
            echo "Note: This is a warning, not a failure"
          else
            echo "✓ All services have OTEL configuration"
          fi

  documentation-check:
    name: Check Documentation Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install markdown linter
        run: npm install -g markdownlint-cli

      - name: Lint markdown files
        run: |
          markdownlint '**/*.md' --ignore node_modules --config .markdownlint.json || true
        continue-on-error: true

      - name: Check for broken links in documentation
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.markdown-link-check.json'
        continue-on-error: true

      - name: Verify required documentation exists
        run: |
          echo "Checking for required documentation files..."
          required_docs=("README.md" "PRODUCTION.md")
          missing_docs=()
          
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              missing_docs+=("$doc")
            else
              echo "✓ Found $doc"
            fi
          done
          
          if [ ${#missing_docs[@]} -gt 0 ]; then
            echo "❌ Missing required documentation:"
            printf '%s\n' "${missing_docs[@]}"
            exit 1
          fi

      - name: Check documentation completeness
        run: |
          echo "Checking README.md completeness..."
          required_sections=(
            "Quick Start"
            "Architecture"
            "Observability"
          )
          
          for section in "${required_sections[@]}"; do
            if grep -qi "$section" README.md; then
              echo "✓ Found section: $section"
            else
              echo "⚠️  Missing or incomplete section: $section"
            fi
          done

  security-scan:
    name: Security and Best Practices Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy security scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: Check for sensitive data
        run: |
          echo "Checking for potential sensitive data..."
          
          # Check for hardcoded passwords
          if grep -r "password.*=.*['\"].*['\"]" --include="*.yml" --include="*.yaml" .; then
            echo "⚠️  Warning: Potential hardcoded passwords found"
          fi
          
          # Check for API keys
          if grep -r "api[_-]key.*=.*['\"].*['\"]" --include="*.yml" --include="*.yaml" .; then
            echo "⚠️  Warning: Potential hardcoded API keys found"
          fi
          
          # Check for tokens
          if grep -r "token.*=.*['\"].*['\"]" --include="*.yml" --include="*.yaml" .; then
            echo "⚠️  Warning: Potential hardcoded tokens found"
          fi

      - name: Check for latest image tags
        run: |
          echo "Checking for :latest tags (not recommended for production)..."
          latest_count=$(grep -r "image:.*:latest" services/ | wc -l)
          
          if [ $latest_count -gt 0 ]; then
            echo "⚠️  Found $latest_count services using :latest tag"
            echo "Consider pinning to specific versions for production"
            grep -r "image:.*:latest" services/
          else
            echo "✓ No :latest tags found"
          fi

  docker-compose-test:
    name: Test Docker Compose Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate docker-compose file
        run: docker-compose config --quiet

      - name: Check for port conflicts
        run: |
          echo "Checking for port conflicts..."
          ports=$(grep -r "- \"[0-9]*:" services/ | sed 's/.*"\([0-9]*\):.*/\1/' | sort)
          duplicates=$(echo "$ports" | uniq -d)
          
          if [ -n "$duplicates" ]; then
            echo "❌ Port conflicts detected:"
            echo "$duplicates"
            exit 1
          else
            echo "✓ No port conflicts detected"
          fi

      - name: Verify volume declarations
        run: |
          echo "Verifying all volumes are declared..."
          # Extract volume names from service files
          used_volumes=$(grep -r "- [a-z_]*:" services/ | grep -v "ports:" | grep -v "environment:" | sed 's/.*- \([a-z_]*\):.*/\1/' | sort -u)
          
          # Check if volumes are declared in docker-compose.yml
          for volume in $used_volumes; do
            if grep -q "^  $volume:" docker-compose.yml; then
              echo "✓ Volume declared: $volume"
            else
              echo "⚠️  Volume not declared in docker-compose.yml: $volume"
            fi
          done

  report-summary:
    name: Generate Quality Report
    runs-on: ubuntu-latest
    needs: [yaml-validation, production-config-check, documentation-check, security-scan, docker-compose-test]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate summary report
        run: |
          echo "# Configuration Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ YAML Validation: ${{ needs.yaml-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Production Config: ${{ needs.production-config-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Documentation: ${{ needs.documentation-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Docker Compose: ${{ needs.docker-compose-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Service Count" >> $GITHUB_STEP_SUMMARY
          service_count=$(ls -1 services/*.yml | wc -l)
          echo "Total services configured: $service_count" >> $GITHUB_STEP_SUMMARY
